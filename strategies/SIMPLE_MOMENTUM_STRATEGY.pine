//@version=5
strategy("Simple Momentum Strategy", shorttitle="Momentum", overlay=true, initial_capital=100000, default_qty_type=strategy.percent_of_equity, default_qty_value=100, commission_type=strategy.commission.percent, commission_value=0.1, slippage=2)

// ============================================================================
// SIMPLE MOMENTUM STRATEGY - Evidence-Based
// ============================================================================
//
// CORE CONCEPT:
// - Buy when price > moving average (uptrend)
// - Sell when price < moving average (downtrend)
// - Use volatility-based position sizing
// - ATR-based stops
//
// EVIDENCE: Century-scale momentum (Moskowitz 2012, Hurst 2017)
//
// ============================================================================

// === INPUTS ===
lookback = input.int(200, "Trend Lookback", minval=50, maxval=300, group="Signal")
use_vol_target = input.bool(true, "Use Volatility Targeting", group="Position Sizing")
target_vol = input.float(15.0, "Target Volatility %", minval=5, maxval=30, group="Position Sizing")
max_leverage = input.float(2.5, "Max Leverage", minval=1.0, maxval=4.0, group="Position Sizing")

atr_len = input.int(20, "ATR Period", minval=5, group="Risk Management")
stop_atr = input.float(3.0, "Stop ATR Multiple", minval=1.0, maxval=5.0, step=0.5, group="Risk Management")
use_trailing = input.bool(true, "Use Trailing Stop", group="Risk Management")

benchmark_sym = input.symbol("SPY", "Benchmark", group="Benchmark")

// === SIGNAL ===
ma = ta.sma(close, lookback)
trend_up = close > ma
trend_down = close < ma

// === VOLATILITY ===
daily_ret = math.log(close / close[1])
realized_vol = ta.stdev(daily_ret, 60) * math.sqrt(252) * 100

// === POSITION SIZING ===
leverage = 1.0
if use_vol_target and realized_vol > 0
    leverage := target_vol / realized_vol
    leverage := math.min(leverage, max_leverage)

// === ATR STOP ===
atr = ta.atr(atr_len)
long_stop = close - atr * stop_atr
short_stop = close + atr * stop_atr

var float trail_stop = na

// === ENTRIES ===
if trend_up and strategy.position_size == 0
    strategy.entry("Long", strategy.long, qty=leverage)
    trail_stop := long_stop

if trend_down and strategy.position_size == 0
    strategy.entry("Short", strategy.short, qty=leverage)
    trail_stop := short_stop

// === EXITS ===
in_long = strategy.position_size > 0
in_short = strategy.position_size < 0

if in_long
    if use_trailing
        trail_stop := math.max(nz(trail_stop), long_stop)
    else
        trail_stop := long_stop
    strategy.exit("Stop", "Long", stop=trail_stop)

if in_short
    if use_trailing
        trail_stop := math.min(nz(trail_stop), short_stop)
    else
        trail_stop := short_stop
    strategy.exit("Stop", "Short", stop=trail_stop)

// === BENCHMARK ===
var float bh_entry = na
var float bh_qty = 0.0
bh_price = request.security(benchmark_sym, timeframe.period, close, lookahead=barmerge.lookahead_off)

if na(bh_entry)
    bh_entry := bh_price
    bh_qty := strategy.initial_capital / bh_price

bh_equity = bh_qty * bh_price
bh_return = (bh_price / bh_entry - 1) * 100
strat_return = (strategy.equity / strategy.initial_capital - 1) * 100
ratio = bh_return > 0 ? strat_return / bh_return : 0

// === METRICS ===
var float peak = strategy.initial_capital
peak := math.max(peak, strategy.equity)
dd_pct = (strategy.equity - peak) / peak * 100

trades = strategy.closedtrades
wins = strategy.wintrades
pf = strategy.grossloss != 0 ? strategy.grossprofit / math.abs(strategy.grossloss) : 0
wr = trades > 0 ? wins / trades * 100 : 0

// === PLOTS ===
plot(ma, "Trend MA", color=color.orange, linewidth=2)
plot(strategy.position_size != 0 ? trail_stop : na, "Stop", color=color.red, linewidth=2, style=plot.style_circles)
bgcolor(trend_up ? color.new(color.green, 95) : color.new(color.red, 95))

// === TABLE ===
var table t = table.new(position.top_right, 2, 9, border_width=1)
if barstate.islast
    table.cell(t, 0, 0, "METRIC", bgcolor=color.gray, text_color=color.white)
    table.cell(t, 1, 0, "VALUE", bgcolor=color.gray, text_color=color.white)

    table.cell(t, 0, 1, "Strategy Return")
    table.cell(t, 1, 1, str.tostring(strat_return, "#.#") + "%", text_color=strat_return > 0 ? color.lime : color.red)

    table.cell(t, 0, 2, "Benchmark Return")
    table.cell(t, 1, 2, str.tostring(bh_return, "#.#") + "%")

    table.cell(t, 0, 3, "Ratio")
    table.cell(t, 1, 3, str.tostring(ratio, "#.##") + "x", text_color=ratio > 1 ? color.lime : color.red)

    table.cell(t, 0, 4, "Max DD")
    table.cell(t, 1, 4, str.tostring(dd_pct, "#.#") + "%", text_color=color.red)

    table.cell(t, 0, 5, "Profit Factor")
    table.cell(t, 1, 5, str.tostring(pf, "#.##"))

    table.cell(t, 0, 6, "Win Rate")
    table.cell(t, 1, 6, str.tostring(wr, "#.#") + "%")

    table.cell(t, 0, 7, "Trades")
    table.cell(t, 1, 7, str.tostring(trades))

    table.cell(t, 0, 8, "BEATS B&H?", bgcolor=color.gray, text_color=color.white)
    table.cell(t, 1, 8, ratio > 1 ? "YES ✅" : "NO ❌", bgcolor=color.gray, text_color=ratio > 1 ? color.lime : color.red)
